<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beställ din box – Sweet & Beauty</title>

  <!-- (valfritt) snyggare font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#f5f7fa; --bg2:#c3cfe2;
      --card:#ffffff; --text:#0f172a; --muted:#6b7280;
      --border:#e5e7eb; --ring:#94a3b8;
      --brand:#28a745; --brandHover:#218838;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg1:#0b1220; --bg2:#111827;
        --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
        --border:#1f2937; --ring:#334155;
        --brand:#34d399; --brandHover:#10b981;
      }
      ::placeholder{color:#6b7280;}
    }

    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0; padding:24px;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      display:grid; place-items:center;
      font:16px/1.5 Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans";
      color:var(--text);
    }

    .container{
      width:100%; max-width:620px; background:var(--card);
      border:1px solid var(--border); border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.08);
      padding:28px; animation:fadeIn .45s ease;
    }

    h1{margin:0 0 6px; text-align:center; font-size:24px}
    .lead{margin:0 0 18px; text-align:center; color:var(--muted); font-size:14px}

    label{display:block; font-weight:600; margin-top:14px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }

    input[type="text"], input[type="email"], input[type="date"], select, textarea{
      width:100%; margin-top:8px; padding:12px 14px; border:1px solid var(--border);
      border-radius:12px; background:transparent; color:var(--text); font-size:15px;
      outline:none; transition:box-shadow .15s ease,border-color .15s ease, background .15s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--ring);
      box-shadow:0 0 0 4px color-mix(in oklab, var(--ring) 25%, transparent);
    }
    textarea{min-height:96px; resize:vertical}

    /* Radio-kort för leveransval */
    .radio-group{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px}
    .radio-card{
      display:flex; align-items:center; gap:10px; padding:12px 14px;
      border:1px solid var(--border); border-radius:12px; cursor:pointer; user-select:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .radio-card input{accent-color:var(--brand)}
    .radio-card:hover{border-color:var(--ring); box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .radio-card:has(input:checked){
      border-color:var(--brand);
      box-shadow:0 0 0 4px color-mix(in oklab, var(--brand) 22%, transparent);
      background:color-mix(in oklab, var(--brand) 6%, transparent);
    }

    .summary{
      margin-top:14px; padding:12px 14px;
      background:color-mix(in oklab, var(--ring) 10%, transparent);
      border:1px dashed var(--ring); border-radius:12px; font-size:14px; color:var(--text);
    }

    button{
      margin-top:18px; width:100%; padding:14px;
      border:none; border-radius:12px; background:var(--brand); color:#fff;
      font-weight:700; font-size:16px; cursor:pointer; transition: background .2s ease, transform .02s ease;
    }
    button:hover{background:var(--brandHover)}
    button:active{transform: translateY(1px)}
    button[disabled]{opacity:.6; cursor:not-allowed}

    #status{min-height:22px; margin-top:12px; text-align:center; font-weight:700}
    small.muted{color:var(--muted)}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
  </style>
</head>
<body>
  <main class="container" role="main">
    <h1>Beställ din box – Sweet &amp; Beauty</h1>
    <p class="lead">Vi har begränsat antal boxar per dag. Betalning via Swish för att bekräfta din order.</p>

    <form id="orderForm">
      <label for="namn">Namn</label>
      <input type="text" id="namn" name="namn" required>

      <div class="row">
        <div>
          <label for="telefon">Telefonnummer</label>
          <input type="text" id="telefon" name="telefon" inputmode="tel" placeholder="0701234567" pattern="^[0-9+ ()-]{7,}$" required>
          <small class="muted">Ex: 0701234567</small>
        </div>
        <div>
          <label for="email">E-post</label>
          <input type="email" id="email" name="email" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="antal">Antal boxar</label>
          <select id="antal" name="antal" required>
            <option value="" selected>Välj antal</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          </select>
        </div>
        <div>
          <label for="datum">Önskat datum</label>
          <input type="date" id="datum" name="datum" required>
          <small class="muted">Tidigare än detta spärras automatiskt.</small>
        </div>
      </div>

      <label>Upphämtning eller leverans</label>
      <div class="radio-group" role="radiogroup" aria-label="Leveransval">
        <label class="radio-card">
          <input type="radio" name="metod" value="Upphämtning" required>
          Upphämtning
        </label>
        <label class="radio-card">
          <input type="radio" name="metod" value="Leverans">
          Leverans (250 kr)
        </label>
      </div>

      <label for="adress">Adress (om leverans)</label>
      <input type="text" id="adress" name="adress" placeholder="Gata, postnummer, ort" disabled>

      <label for="onskemal">Övriga önskemål</label>
      <textarea id="onskemal" name="onskemal" placeholder="Smaker, tidsspann, allergier m.m."></textarea>

      <div class="summary" id="summary">Antal: – • Leveransavgift: 0 kr</div>

      <button type="submit" id="submitBtn">Skicka beställning</button>
    </form>

    <p id="status" aria-live="polite"></p>
  </main>

 <script>
  // Din befintliga webapp-URL
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz9zJFEz44_-1OKGBMhxgOl4jSmQlgPgs-9zoPmdE_urGv_efoGUSP693k41x5c_76A/exec";

  const $ = (s)=>document.querySelector(s);
  const statusEl = document.getElementById("status");
  const form = document.getElementById("orderForm");

  // 2.1: gömt fält för datum (så Sheets-kopplingen är oförändrad)
  // Lägg detta input i din HTML strax före submit-knappen om du vill se det:
  // <input type="hidden" id="datum" name="datum">
  // Om du inte vill röra HTML just nu, skapar vi det dynamiskt:
  let hiddenDateInput = document.querySelector('input[name="datum"]');
  if (!hiddenDateInput) {
    hiddenDateInput = document.createElement('input');
    hiddenDateInput.type = 'hidden';
    hiddenDateInput.name = 'datum';
    hiddenDateInput.id = 'datum';
    form.appendChild(hiddenDateInput);
  }

  // 2.2: ersätt ditt <input type="date"...> i HTML med en select:
  // <select id="dateSelect" required></select>
  // Om du inte redan lagt till den i HTML skapar vi den här och stoppar den där det gamla datumfältet fanns:
  let dateSelect = document.getElementById('dateSelect');
  if (!dateSelect) {
    // hitta stället efter label "Önskat datum"
    const label = Array.from(document.querySelectorAll('label')).find(l => /Önskat datum/i.test(l.textContent));
    dateSelect = document.createElement('select');
    dateSelect.id = 'dateSelect';
    dateSelect.required = true;
    if (label && label.nextElementSibling && label.nextElementSibling.tagName === 'INPUT') {
      // ersätt input[type=date]
      label.parentNode.replaceChild(dateSelect, label.nextElementSibling);
    } else {
      // annars lägg sist
      form.insertBefore(dateSelect, form.querySelector('button[type="submit"]'));
    }
  }

  // 2.3: Hämta availability (nästa 30 dagar) och fyll select
  async function loadAvailability() {
    dateSelect.innerHTML = '<option value="">Laddar tillgängliga datum…</option>';
    try {
      const res = await fetch(`${SCRIPT_URL}?action=availability&days=30`, { method: 'GET' });
      const data = await res.json();
      const list = Array.isArray(data?.dates) ? data.dates : [];

      // Visa bara ons/lör/sön med remaining>0
      if (!list.length) {
        dateSelect.innerHTML = '<option value="">Inga tider tillgängliga just nu</option>';
        return;
      }
      dateSelect.innerHTML = '<option value="">Välj datum</option>';
      for (const item of list) {
        const d = new Date(item.date);
        const weekday = ['Sön','Mån','Tis','Ons','Tors','Fre','Lör'][d.getDay()];
        const opt = document.createElement('option');
        opt.value = item.date;
        opt.textContent = `${weekday} ${item.date} — ${item.remaining} kvar`;
        opt.dataset.remaining = String(item.remaining);
        dateSelect.appendChild(opt);
      }
    } catch (err) {
      dateSelect.innerHTML = '<option value="">Kunde inte ladda tider</option>';
    }
  }

  // 2.4: Styr “antal” mot remaining
  const antalSel = document.querySelector('select[name="antal"]');
  function validateAntalVsRemaining() {
    const val = dateSelect.value;
    const opt = val ? dateSelect.querySelector(`option[value="${val}"]`) : null;
    const remaining = opt ? Number(opt.dataset.remaining || 0) : 0;
    const antal = Number(antalSel?.value || 0);
    const submitBtn = form.querySelector('button[type="submit"]');

    if (antal > remaining) {
      submitBtn.disabled = true;
      statusEl.textContent = `Endast ${remaining} kvar för valt datum.`;
    } else {
      submitBtn.disabled = false;
      statusEl.textContent = '';
    }
  }

  dateSelect.addEventListener('change', () => {
    hiddenDateInput.value = dateSelect.value || '';
    validateAntalVsRemaining();
  });
  antalSel?.addEventListener('change', validateAntalVsRemaining);

  // Init: ladda tider
  loadAvailability();

  // Adressfältet styrs av leveransval
  function toggleAddress() {
    const metod = document.querySelector('input[name="metod"]:checked')?.value;
    const addr = document.querySelector('input[name="adress"]');
    if (!addr) return;
    if (metod === 'Leverans') {
      addr.disabled = false; addr.required = true;
    } else {
      addr.disabled = true; addr.required = false; addr.value = '';
    }
  }
  document.querySelectorAll('input[name="metod"]').forEach(r => r.addEventListener('change', toggleAddress));
  toggleAddress();

  // Submit – oförändrat, men vi uppdaterar availability direkt efter OK
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = form.querySelector('button[type="submit"]');
    btn.disabled = true; btn.textContent = 'Skickar…'; statusEl.textContent = '';
    try {
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: new FormData(form) });
      const text = await res.text();
      if (res.ok && text.startsWith('OK')) {
        statusEl.textContent = '✅ Tack! Din beställning är mottagen.';
        form.reset();
        hiddenDateInput.value = '';
        await loadAvailability();     // uppdatera listan (datum med 0 kvar försvinner)
      } else {
        const msg = (text.startsWith('ERROR:') ? text.replace('ERROR:','') : 'Något gick fel, försök igen.');
        statusEl.textContent = `❌ ${msg}`;
      }
    } catch (err) {
      statusEl.textContent = '❌ Tekniskt fel vid skickning. Försök igen.';
    } finally {
      btn.disabled = false; btn.textContent = 'Skicka beställning';
      validateAntalVsRemaining();
    }
  });
</script>
</body>
</html>
